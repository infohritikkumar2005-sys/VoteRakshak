<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Login - Election Portal</title>
  <link rel="stylesheet" href="style.css" />

  <!-- MediaPipe FaceMesh -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <style>
    /* Hide oval ONLY for admin page */
    body.admin-page .face-guide,
    body.admin-page .face-guide.good,
    body.admin-page .face-guide.ready,
    body.admin-page .face-guide.bad {
      display: none !important;
    }

    /* Camera glow like index page */
    #camBox .video-wrap {
      width: 85%;
      max-width: 350px;
      margin: auto;
      transition: .3s ease;
    }

    #camBox .video-wrap.active {
      box-shadow: 0 0 15px rgba(19, 136, 8, 0.8), 0 0 25px rgba(19, 136, 8, 0.6);
      border: 2px solid #138808 !important;
    }

    #camBox .video-wrap.idle {
      box-shadow: 0 0 12px rgba(255, 153, 51, 0.6);
      border: 2px solid #FF9933 !important;
    }
  </style>
</head>

<body class="admin-page">

  <div class="strip"></div>
  <header class="gov-header">
    <div style="display:flex;align-items:center;gap:10px;">
      <img class="ashoka"
        src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Emblem_of_India.svg/500px-Emblem_of_India.svg.png">
      <div>
        <b>Vote Rakshak</b><br>
        <span style="font-size:12px;">Admin Authentication</span>
      </div>
    </div>
    <nav class="top-links">
      <a href="/">Home</a>
      <a href="/cast-vote">Vote</a>
      <a href="/results">Results</a>
      <a href="/verify">Verify</a>
    </nav>
  </header>

  <div class="container">
    <div class="card" style="max-width:520px;margin:auto;">

      <h3 style="color:#0a2a63">Admin Login</h3>

      <label class="label">Username</label>
      <input id="username" class="input" placeholder="Admin Username" />

      <label class="label">Password</label>
      <input id="password" type="password" class="input" placeholder="Password" />

      <button id="step1" class="btn secondary" style="width:100%;margin-top:10px;">Verify Credentials</button>
      <p id="msg" class="small" style="margin-top:10px;">Step 1: Verify username & password</p>

      <!-- CAMERA BLOCK -->
      <div id="camBox" style="display:none;margin-top:20px;text-align:center;">
        <label class="label">Face Verification</label>

        <div class="video-wrap idle" style="position:relative;">
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas" style="display:none;"></canvas>
          <div id="countdown" class="countdown"></div>
          <div id="livenessOverlayAdmin"
            style="position:absolute; bottom:10px; left:50%; transform:translateX(-50%); text-align:center; background:rgba(0,0,0,0.7); color:#fff; font-size:13px; font-weight:bold; padding:6px 14px; border-radius:20px; display:none; white-space:nowrap; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
            ‚ö†Ô∏è System Active
          </div>
        </div>

        <button id="capture" class="btn" style="margin-top:10px;width:100%;">Capture & Login</button>

        <div id="previewBox" style="display:none;text-align:center;margin-top:10px;">
          <p>Captured:</p>
          <img id="previewImg"
            style="width:160px;border-radius:10px;border:2px solid #004aad;box-shadow:0 0 8px rgba(0,0,0,.3)">
        </div>
      </div>
    </div>
  </div>

  <script>
    let captured = null, stable = 0, autoReady = true;
    let livenessState = 0; // 0: Turn Head, 1: Blink, 2: Done
    let isEyeClosed = false;

    const msg = document.getElementById("msg");
    const video = document.getElementById("video");
    const preview = document.getElementById("previewImg");
    const countdown = document.getElementById("countdown");
    const camBox = document.querySelector("#camBox .video-wrap");
    const livenessOverlay = document.getElementById("livenessOverlayAdmin");

    /* EAR Helper for Liveness Detection */
    function getEAR(eye, landmarks) {
      const p1 = landmarks[eye[0]];
      const p2 = landmarks[eye[1]];
      const p3 = landmarks[eye[2]];
      const p4 = landmarks[eye[3]];
      const p5 = landmarks[eye[4]];
      const p6 = landmarks[eye[5]];
      const v1 = Math.hypot(p2.x - p6.x, p2.y - p6.y);
      const v2 = Math.hypot(p3.x - p5.x, p3.y - p5.y);
      const h = Math.hypot(p1.x - p4.x, p1.y - p4.y);
      return (v1 + v2) / (2.0 * h);
    }
    const leftEyeIdx = [362, 385, 387, 263, 373, 380];
    const rightEyeIdx = [33, 160, 158, 133, 153, 144];

    /* Step 1 - Verify Login Credentials */
    document.getElementById("step1").onclick = async () => {
      let u = username.value.trim(), p = password.value.trim();
      if (!u || !p) return msg.innerText = "Enter credentials first";

      const res = await fetch("/admin/login_step1", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: u, password: p })
      });
      const d = await res.json();

      if (!res.ok) return msg.innerText = d.error || "Invalid credentials";

      msg.innerText = "Credentials Verified ‚úî Proceed with Face Verification";
      document.getElementById("camBox").style.display = "block";
      startCamera();
    };

    /* FaceMesh Setup */
    const faceMesh = new FaceMesh({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}` });
    faceMesh.setOptions({ maxNumFaces: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
    faceMesh.onResults(onFaceDetect);

    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      const cam = new Camera(video, { onFrame: async () => await faceMesh.send({ image: video }) });
      cam.start();
    }

    /* Face Detection Visual Feedback */
    function onFaceDetect(res) {
      if (res.multiFaceLandmarks.length) {
        camBox.classList.add("active");
        camBox.classList.remove("idle");

        if (autoReady) {
          livenessOverlay.style.display = "block";
          const lmk = res.multiFaceLandmarks[0];

          if (livenessState === 0) {
            livenessOverlay.innerHTML = "üë§ Please <b style='color:#00ff88;'>TURN HEAD</b> slightly (Left/Right)";

            // Check Yaw (Nose vs Cheeks)
            const nose = lmk[1];
            const leftCheek = lmk[234];
            const rightCheek = lmk[454];

            const distLeft = Math.abs(nose.x - leftCheek.x);
            const distRight = Math.abs(nose.x - rightCheek.x);
            const ratio = distLeft / (distRight + 0.0001);

            // Normal is ~1.0. Turned is > 1.7 or < 0.6
            if (ratio < 0.55 || ratio > 1.8) {
              livenessState = 1; // move to blink
            }
          } else if (livenessState === 1) {
            livenessOverlay.innerHTML = "üëÅÔ∏è Look straight and <b style='color:#00ff88;'>BLINK</b> slowly";

            const leftEAR = getEAR(leftEyeIdx, lmk);
            const rightEAR = getEAR(rightEyeIdx, lmk);
            const avgEAR = (leftEAR + rightEAR) / 2.0;

            if (avgEAR < 0.22) {
              isEyeClosed = true;
            } else if (isEyeClosed && avgEAR > 0.25) {
              livenessState = 2; // done
              livenessOverlay.innerHTML = "‚úÖ Liveness Verified! Hold Still...";
              livenessOverlay.style.color = "#00ff88";
              livenessOverlay.style.background = "rgba(0,0,0,0.8)";
            }
          } else if (livenessState === 2) {
            stable++;
            if (stable > 35) {
              autoReady = false;
              runAutoCapture();
            }
          }
        } else {
          livenessOverlay.style.display = "none";
        }
      } else {
        camBox.classList.remove("active");
        camBox.classList.add("idle");
        stable = 0;
        livenessOverlay.style.display = "none";
      }
    }

    /* Auto Capture Timer */
    function runAutoCapture() {
      let s = 3;
      countdown.style.display = "flex";
      countdown.innerText = s;

      let t = setInterval(() => {
        s--; countdown.innerText = s;
        if (s <= 0) {
          clearInterval(t);
          countdown.style.display = "none";
          captureImage();
        }
      }, 700);
    }

    document.getElementById("capture").onclick = captureImage;

    function captureImage() {
      const c = document.createElement("canvas");
      c.width = video.videoWidth; c.height = video.videoHeight;
      const x = c.getContext("2d");

      x.translate(c.width, 0); x.scale(-1, 1);
      x.drawImage(video, 0, 0);

      captured = c.toDataURL("image/jpeg", 0.9);
      preview.src = captured;
      document.getElementById("previewBox").style.display = "block";
      livenessOverlay.style.display = "none"; // Hide

      msg.innerText = "Verifying face liveness & identity...";
      loginWithFace();
    }



    async function loginWithFace() {
      const form = new FormData();
      form.append("username", username.value.trim());
      form.append("image", captured);

      const res = await fetch("/admin/login_face", { method: "POST", body: form });
      const d = await res.json();

      msg.innerText = res.ok ? "Login Successful ‚úî Redirecting..." : "Face Mismatch ‚ùå";

      if (res.ok) {
        localStorage.setItem("admin_token", d.token);
        setTimeout(() => location.href = "/admin-dashboard", 700);
      }
    }
  </script>

</body>

</html>